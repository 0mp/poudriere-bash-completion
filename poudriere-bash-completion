# vim: filetype=sh
#
# SPDX-License-Identifier: BSD-2-Clause-FreeBSD
#
# Copyright (c) 2018 Matusz Piotrowski <0mp@FreeBSD.org>
# All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
#
# THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND
# ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
# ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
# OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
# HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
# LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
# OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
# SUCH DAMAGE.

_poudriere_freebsd_version() {
    # XXX: It might be non exhaustive.
    # For example it does not include options like:
    # stable/11, stable/10@123456
    COMPREPLY+=($(compgen -W "10.3 10.4 11.1" -S '-RELEASE' -- "$cur"))
    COMPREPLY+=($(compgen -W "10.4 11.1" -S '-STABLE' -- "$cur"))
    COMPREPLY+=($(compgen -W "12.0" -S '-CURRENT' -- "$cur"))
}

_poudriere_filesystem() {
    COMPREPLY=($(compgen -W "none $(zfs list | awk 'NR > 1{print $1}')" -- "$cur"))
    if [[ ${#COMPREPLY[@]} == 1 ]] && [[ $COMPREPLY != none ]]; then
        # XXX: Is it reasonable to assume that someone would continue to append somthing to an existing name?
        compopt -o nospace
    fi
}

# TODO: It cannot be easily done as far as I know.
_poudriere_set_list() {
    compopt -o default # XXX
}

# XXX: It might be non exhaustive.
_poudriere_architecture() {
    COMPREPLY=($(compgen -W 'amd64 i386' -- "$cur"))
}

# TODO: Support the second argument.
_poudriere_jobs_number() {
    COMPREPLY=($(compgen -W "$(seq 1 $(sysctl -n hw.ncpu))" -- "$cur"))
}

_poudriere_ports_list() {
    COMPREPLY=($(compgen -W "$(poudriere ports -l | awk 'NR > 1 {print $1}')" -- "$cur"))
}

# XXX: A little bit slow due to poudriere jail -l.
_poudriere_jails_list() {
    COMPREPLY=($(compgen -W "$(poudriere jail -l | awk 'NR > 1 {print $1}')" -- "$cur"))
}

# TODO: Parse poudriere status.
_poudriere_buildname() {
    compopt -o default
}

_poudriere_absolute_path() {
    COMPREPLY=($(compgen -f "${cur:-/}" -- "$cur"))
}

_poudriere_direct_port() {
    # Find a ports tree to search for ports.
    local prev_word=
    local ports_tree=
    # Find out if a ports tree is already specified with -p.
    for w in ${words[@]}; do
        if [[ $w == -p ]]; then
            prev_word=-p
        elif [[ $prev_word == -p ]]; then
            ports_tree="$w"
            break
        fi
    done
    # Find out if the default try is present.
    if [[ -z $ports_tree ]] && poudriere ports -l | awk '/^default */{found=1} END{if (found != 1) {exit 1}}'; then
        ports_tree=default
    elif [[ -z $ports_tree ]]; then
        return
    fi
    local ports_tree_path="$(poudriere ports -l | awk -v tree=$ports_tree 'NR > 1{if (match($1, tree)) {print $5}}')"
    # Complete port name.
    if [[ $cur =~ .*/.* ]]; then
        COMPREPLY=($(compgen -W "$(
        command cd "$ports_tree_path" && LANG=C find "${cur%%/*}/" -mindepth 1 -maxdepth 1 -type d -name "${cur##*/}*"
        )" -- "$cur"))
    else # Complete category.
        COMPREPLY=($(compgen -W "$(command cd "$ports_tree_path" && LANG=C find * -maxdepth 0 -type d -name '[^.A-Z]*' -prune)" -S "/" -- "$cur")) && compopt -o nospace
    fi
}

_poudriere()
{
    local cur prev words cword
    _init_completion || return

    local command_list=(bulk distclean daemon help image jail logclean \
        ports pkgclean options queue status testport version)

    # Is the command already selected?
    local pipe_separated_command_list="$(tr ' ' '|' <<< "${command_list[@]}")"
    local selected_command=
    for (( i=0 ; i < "${#words[@]}" ; i++ )); do
        word="${words[$i]}"
        if [[ $word =~ $pipe_separated_command_list ]]; then
            if [[ $i > 0 ]] && [[ ${words[$(( i - 1 ))]} =~ -e ]]; then
                continue
            else
                selected_command="$word"
                break
            fi
        fi
    done

    if [[ -z $selected_command ]]; then
        case "$prev" in
            -e)
                compopt -o default
                ;;
            *)
                if [[ $cur == -* ]]; then
                    COMPREPLY=($(compgen -W '-e -A -N -v' -- "$cur"))
                else
                    COMPREPLY=($(compgen -W "${command_list[*]}" -- "$cur"))
                fi
                ;;
        esac
    else
        case "$selected_command" in
            bulk)
                case "$prev" in
                    -B)
                        _poudriere_buildname
                        ;;
                    -f)
                        _poudriere_absolute_path
                        ;;
                    -J)
                        _poudriere_jobs_number
                        ;;
                    -p)
                        _poudriere_ports_list
                        ;;
                    *)
                        if [[ $cur != -* ]]; then
                            _poudriere_direct_port
                        fi
                        if [[ ${COMPREPLY[@]} -eq 0 ]]; then
                            COMPREPLY=($(compgen -W "$(_parse_help poudriere $selected_command)" -- "$cur"))
                        fi
                        ;;
                esac
                ;;

            distclean)
                case "$prev" in
                    -f)
                        _poudriere_absolute_path
                        ;;
                    -J)
                        _poudriere_jobs_number
                        ;;
                    -p)
                        _poudriere_ports_list
                        ;;
                    *)
                        if [[ $cur != -* ]]; then
                            _poudriere_direct_port
                        fi
                        if [[ ${COMPREPLY[@]} -eq 0 ]]; then
                            COMPREPLY=($(compgen -W "$(_parse_help poudriere $selected_command)" -- "$cur"))
                        fi
                        ;;
                esac
                ;;

            # daemon) ;;

            # help) ;;

            image)
                case "$prev" in
                    -c|-f|-h|-m|-o|-s|-X)
                        # XXX: Maybe there is a better way to complete size (-s).
                        compopt -o default
                        ;;
                    -j)
                        _poudriere_jails_list
                        ;;
                    -p)
                        _poudriere_ports_list
                        ;;
                    -t)
                        COMPREPLY=($(compgen -W 'iso iso+mfs iso+zmfs usb usb+mfs usb+zmfs rawdisk zrawdisk tar firmware rawfirmware embedded' -- "$cur"))
                        ;;
                    -z)
                        _poudriere_set_list
                        ;;
                    *)
                        COMPREPLY=($(compgen -W "$(_parse_help poudriere $selected_command)" -X '--' -- "$cur"))
                        ;;
                esac
                ;;

            jail)
                case "$prev" in
                    -a)
                        _poudriere_architecture
                        ;;
                    -C)
                        COMPREPLY=($(compgen -W "all cache logs packages wkrdirs" -- "$cur"))
                        ;;
                    -f)
                        _poudriere_filesystem
                        ;;
                    -j)
                        _poudriere_jails_list
                        ;;
                    -J)
                        _poudriere_jobs_number
                        ;;
                    -K|-r|-M|-P|-S)
                        compopt -o default
                        ;;
                    -v)
                        _poudriere_freebsd_version
                        ;;
                    -m)
                        # TODO: Complete paths for src= and tar=.
                        COMPREPLY=($(compgen -W "allbsd ftp-archive ftp git http null src= svn svn+file svn+http svn+https svn+ssh tar= url=" -- "$cur"))
                        if [[ ${#COMPREPLY[@]} == 1 && $COMPREPLY == *= ]]; then
                            compopt -o nospace
                        fi
                        ;;
                    -t)
                        _poudriere_freebsd_version
                        ;;
                    -p)
                        _poudriere_ports_list
                        ;;
                    -z)
                        _poudriere_set_list
                        ;;
                    *)
                        COMPREPLY=($(compgen -W "$(_parse_help poudriere $selected_command)" -- "$cur"))
                        ;;
                esac
                ;;

            logclean)
                case "$prev" in
                    -N)
                        COMPREPLY=($(compgen -W "0 1 2 3 4 5 6 7 8 9"))
                        compopt -o nospace
                        ;;
                    -j)
                        _poudriere_jails_list
                        ;;
                    -B)
                        _poudriere_buildname
                        ;;
                    -p)
                        _poudriere_ports_list
                        ;;
                    -z)
                        _poudriere_set_list
                        ;;
                    *)
                        if [[ $cur =~ ^([[:digit:]])+$ ]]; then
                            COMPREPLY=(0 1 2 3 4 5 6 7 8 9)
                            compopt -o nospace
                        else
                            COMPREPLY=($(compgen -W '0 1 2 3 4 5 6 7 8 9 -a -N -j -n -B -p -y -v -z' -- "$cur"))
                        fi
                        ;;
                esac
                ;;

            ports)
                case "$prev" in
                    -B)
                        # XXX: Maybe there are not that many branches and it is possible to actually list them here.
                        compopt -o default
                        ;;
                    -M)
                        compopt -o default
                        ;;
                    -f)
                        _poudriere_filesystem
                        ;;
                    -m)
                        COMPREPLY=($(compgen -W 'portsnap git null svn' -- "$cur"))
                        COMPREPLY+=($(compgen -W "http https file ssh" -P 'svn+' -- "$cur"))
                        ;;
                    -p)
                        _poudriere_ports_list
                        ;;
                    *)
                        COMPREPLY=($(compgen -W '-c -d -l -u -B -F -M -f -k -m -n -p -q -v' -- "$cur"))
                        ;;
                esac
                ;;

            pkgclean)
                case "$prev" in
                    -f)
                        _poudriere_absolute_path
                        ;;
                    -j)
                        _poudriere_jails_list
                        ;;
                    -J)
                        _poudriere_jobs_number
                        ;;
                    -p)
                        _poudriere_ports_list
                        ;;
                    -z)
                        _poudriere_set_list
                        ;;
                    *)
                        if [[ $cur != -* ]]; then
                            _poudriere_direct_port
                        fi
                        if [[ ${COMPREPLY[@]} -eq 0 ]]; then
                            COMPREPLY=($(compgen -W "$(_parse_help poudriere $selected_command)" -- "$cur"))
                        fi
                        ;;
                esac
                ;;

            options)
                case "$prev" in
                    -f)
                        _poudriere_absolute_path
                        ;;
                    -a)
                        _poudriere_architecture
                        ;;
                    -j)
                        _poudriere_jails_list
                        ;;
                    -p)
                        _poudriere_ports_list
                        ;;
                    -z)
                        _poudriere_set_list
                        ;;
                    *)
                        if [[ $cur != -* ]]; then
                            _poudriere_direct_port
                        fi
                        if [[ ${COMPREPLY[@]} -eq 0 ]]; then
                            COMPREPLY=($(compgen -W "$(_parse_help poudriere $selected_command)" -- "$cur"))
                        fi
                        ;;
                esac
                ;;

            # TODO: queue) ;;

            status)
                case "$prev" in
                    -B)
                        _poudriere_buildname
                        ;;
                    -j)
                        _poudriere_jails_list
                        ;;
                    -p)
                        _poudriere_ports_list
                        ;;
                    -z)
                        _poudriere_set_list
                        ;;
                    *)
                        # XXX: _parse_help does not work for some reason.
                        COMPREPLY=($(compgen -W '-a -b -B -c -f -H -j -l -p -r -z' -- "$cur"))
                        ;;
                esac
                ;;

            testport)
                case "$prev" in
                    -o)
                        _poudriere_direct_port
                        ;;
                    -B)
                        _poudriere_buildname
                        ;;
                    -j)
                        _poudriere_jails_list
                        ;;
                    -J)
                        _poudriere_jobs_number
                        ;;
                    -p)
                        _poudriere_ports_list
                        ;;
                    -z)
                        _poudriere_set_list
                        ;;
                    *)
                        if [[ $cur != -* ]]; then
                            _poudriere_direct_port
                        fi
                        if [[ ${COMPREPLY[@]} -eq 0 ]]; then
                            COMPREPLY=($(compgen -W "$(_parse_help poudriere $selected_command) -o" -- "$cur"))
                        fi
                        ;;
                esac
                ;;

            # version) ;;
        esac
    fi
} &&
complete -F _poudriere poudriere
